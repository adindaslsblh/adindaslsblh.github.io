<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AHP Pemilihan Kos – Single Page</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- js-yaml for YAML import/export -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    html, body { background: #0f172a; color: #e2e8f0; }
    .card { background: #0b1220; border: 1px solid #1f2a44; border-radius: 1rem; }
    .kbd { border:1px solid #334155; background:#111827; padding:.15rem .45rem; border-radius:.375rem; font-size:.85rem }
    .tbl th, .tbl td { border-bottom:1px solid #1f2a44; padding:.6rem .5rem; }
    .btn { border-radius: .75rem; padding:.65rem 1rem; border:1px solid #1f2a44; }
    .btn:hover { border-color:#334155; }
    a { color:#93c5fd }
    .grid-auto { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .spin { animation: spin 1s linear infinite } @keyframes spin { to { transform:rotate(360deg) } }
    .muted { color:#94a3b8 }
    .ok    { color:#34d399 }
    .warn  { color:#fbbf24 }
    .bad   { color:#f87171 }
    .mono  { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold">AHP Pemilihan Kos <span class="muted text-base">– Single Page • GitHub Pages ready</span></h1>
    <p class="mt-1 text-sm muted">Kriteria: <span class="mono">Lokasi</span>, <span class="mono">Biaya</span>, <span class="mono">Fasilitas</span>. Subkriteria default disediakan dan bisa diubah.</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24 space-y-6">
    <!-- CONFIG + IMPORT/EXPORT -->
    <section class="card p-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-xl font-semibold">Konfigurasi & Data</h2>
        <div class="flex items-center gap-2">
          <label class="btn cursor-pointer">
            <input id="yamlFile" type="file" accept=".yaml,.yml,.json" class="hidden">
            <span class="flex items-center gap-2"><i data-lucide="upload"></i> Import YAML/JSON</span>
          </label>
          <button id="btnExport" class="btn"><i data-lucide="download" class="mr-2"></i>Export YAML</button>
          <button id="btnReset" class="btn"><i data-lucide="refresh-cw" class="mr-2"></i>Reset</button>
        </div>
      </div>
      <p class="muted mt-2 text-sm">Tip: Simpan pengaturan bobot & daftar alternatif ke satu file <span class="mono">.yaml</span>, gantikan peran MySQL.</p>
      <div id="configState" class="mono text-xs mt-3 muted"></div>
    </section>

    <!-- PAIRWISE: KRITERIA -->
    <section class="card p-5">
      <h2 class="text-xl font-semibold mb-3">1) Perbandingan Berpasangan – Kriteria</h2>
      <div id="matrix-criteria"></div>
      <div class="flex flex-wrap gap-2 mt-3">
        <button class="btn" onclick="equalizeCriteria()">Set Semua = 1</button>
        <button class="btn" onclick="randomizeCriteria()">Acak Nilai</button>
      </div>
      <div id="critStats" class="mt-3 text-sm"></div>
    </section>

    <!-- PAIRWISE: SUB-KRITERIA -->
    <section class="card p-5">
      <h2 class="text-xl font-semibold mb-3">2) Perbandingan Berpasangan – Subkriteria</h2>

      <details open class="mb-3">
        <summary class="cursor-pointer font-medium">Lokasi</summary>
        <div id="matrix-sub-lokasi" class="mt-3"></div>
      </details>

      <details class="mb-3">
        <summary class="cursor-pointer font-medium">Biaya</summary>
        <div id="matrix-sub-biaya" class="mt-3"></div>
      </details>

      <details class="mb-3">
        <summary class="cursor-pointer font-medium">Fasilitas</summary>
        <div id="matrix-sub-fasilitas" class="mt-3"></div>
      </details>

      <div id="subStats" class="mt-3 text-sm"></div>
    </section>

    <!-- ALTERNATIF -->
    <section class="card p-5">
      <h2 class="text-xl font-semibold mb-3">3) Alternatif Kos</h2>

      <form id="altForm" class="grid-auto">
        <div>
          <label class="text-sm muted">Nama Kos</label>
          <input id="altName" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-2" placeholder="Contoh: Kos Mawar">
        </div>
        <div>
          <label class="text-sm muted">Lokasi</label>
          <select id="altLokasi" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-2">
            <option>< 1KM</option>
            <option>1–2 KM</option>
            <option>> 2KM</option>
          </select>
        </div>
        <div>
          <label class="text-sm muted">Biaya</label>
          <select id="altBiaya" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-2">
            <option>< 500 ribu</option>
            <option>500 ribu – 1 jt</option>
            <option>> 1 jt</option>
          </select>
        </div>
        <div>
          <label class="text-sm muted">Fasilitas</label>
          <select id="altFasilitas" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-2">
            <option>Sangat lengkap</option>
            <option>Lengkap</option>
            <option>Kurang lengkap</option>
          </select>
        </div>
        <div class="flex items-end">
          <button class="btn" type="submit"><i data-lucide="plus" class="mr-2"></i>Tambah</button>
        </div>
      </form>

      <div class="overflow-auto mt-4">
        <table class="w-full tbl text-sm">
          <thead class="muted">
            <tr><th>Nama</th><th>Lokasi</th><th>Biaya</th><th>Fasilitas</th><th></th></tr>
          </thead>
          <tbody id="altRows"></tbody>
        </table>
      </div>
    </section>

    <!-- HASIL -->
    <section class="card p-5">
      <div class="flex flex-wrap items-center justify-between">
        <h2 class="text-xl font-semibold mb-3">4) Hitung & Ranking</h2>
        <div class="flex gap-2">
          <button class="btn" onclick="computeAll()"><i data-lucide='calculator' class="mr-2"></i>Hitung</button>
          <button class="btn" onclick="downloadCSV()"><i data-lucide='file-down' class="mr-2"></i>CSV</button>
        </div>
      </div>

      <div id="weightsView" class="grid-auto mt-4"></div>
      <div id="rankView" class="overflow-auto mt-4"></div>
    </section>

    <footer class="text-center text-xs muted">
      &copy; 2025 • AHP Pemilihan Kos • Single-file demo. Dapat di-host di GitHub Pages.
    </footer>
  </main>

<script>
window.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });

/** ====== Default Config (can be exported as YAML) ====== **/
let cfg = {
  criteria: ["Lokasi","Biaya","Fasilitas"],
  subcriteria: {
    "Lokasi": ["< 1KM","1–2 KM","> 2KM"],
    "Biaya": ["< 500 ribu","500 ribu – 1 jt","> 1 jt"],
    "Fasilitas": ["Sangat lengkap","Lengkap","Kurang lengkap"]
  },
  // pairwise matrices: n x n, diagonal 1, a_ji = 1/a_ij
  matrices: {
    criteria: [[1,1,1],[1,1,1],[1,1,1]], // default equal
    sub: {
      "Lokasi":     [[1,1,1],[1,1,1],[1,1,1]],
      "Biaya":      [[1,1,1],[1,1,1],[1,1,1]],
      "Fasilitas":  [[1,1,1],[1,1,1],[1,1,1]],
    }
  },
  alternatives: [
    {name:"Kos Mawar", lokasi:"< 1KM", biaya:"500 ribu – 1 jt", fasilitas:"Lengkap"},
    {name:"Kos Melati", lokasi:"1–2 KM", biaya:"< 500 ribu", fasilitas:"Kurang lengkap"},
    {name:"Kos Anggrek", lokasi:"> 2KM", biaya:"> 1 jt", fasilitas:"Sangat lengkap"},
  ]
};

// Saaty scale options
const saaty = [1,2,3,4,5,6,7,8,9];
const RI = { // Random Index for n=1..10
  1:0.0, 2:0.0, 3:0.58, 4:0.90, 5:1.12, 6:1.24, 7:1.32, 8:1.41, 9:1.45, 10:1.49
};

function setConfigState(msg) {
  document.getElementById('configState').textContent = msg;
}

/** ====== Matrix UI Builders ====== **/
function buildPairwiseTable(containerId, labels, matrix, onChange) {
  const el = document.getElementById(containerId);
  const n = labels.length;
  let html = '<div class="overflow-auto"><table class="tbl text-sm w-full"><thead><tr><th></th>';
  for (let j=0;j<n;j++) html += `<th>${labels[j]}</th>`;
  html += `</tr></thead><tbody>`;
  for (let i=0;i<n;i++){
    html += `<tr><th class="text-left muted font-medium">${labels[i]}</th>`;
    for (let j=0;j<n;j++){
      if (i===j){
        html += `<td class="text-center">1</td>`;
      } else if (j>i){
        const val = matrix[i][j];
        html += `<td>
          <div class="flex items-center gap-2">
            <select data-i="${i}" data-j="${j}" class="bg-slate-900 border border-slate-700 rounded-lg p-1">
              ${saaty.map(v=>`<option value="${v}" ${v==val?'selected':''}>${v}</option>`).join('')}
            </select>
            <span class="muted">(${labels[i]} vs ${labels[j]})</span>
          </div>
        </td>`;
      } else {
        const inv = (1 / matrix[j][i]).toFixed(4);
        html += `<td class="text-center muted">${inv}</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  el.innerHTML = html;
  el.querySelectorAll('select').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const i = +sel.dataset.i, j = +sel.dataset.j, v = +sel.value;
      onChange(i,j,v);
    });
  });
}

function rebuildAllMatricesUI(){
  buildPairwiseTable('matrix-criteria', cfg.criteria, cfg.matrices.criteria, (i,j,v)=>{
    cfg.matrices.criteria[i][j]=v;
    cfg.matrices.criteria[j][i]=1/v;
    rebuildAllMatricesUI();
  });
  buildPairwiseTable('matrix-sub-lokasi', cfg.subcriteria["Lokasi"], cfg.matrices.sub["Lokasi"], (i,j,v)=>{
    cfg.matrices.sub["Lokasi"][i][j]=v; cfg.matrices.sub["Lokasi"][j][i]=1/v; rebuildAllMatricesUI();
  });
  buildPairwiseTable('matrix-sub-biaya', cfg.subcriteria["Biaya"], cfg.matrices.sub["Biaya"], (i,j,v)=>{
    cfg.matrices.sub["Biaya"][i][j]=v; cfg.matrices.sub["Biaya"][j][i]=1/v; rebuildAllMatricesUI();
  });
  buildPairwiseTable('matrix-sub-fasilitas', cfg.subcriteria["Fasilitas"], cfg.matrices.sub["Fasilitas"], (i,j,v)=>{
    cfg.matrices.sub["Fasilitas"][i][j]=v; cfg.matrices.sub["Fasilitas"][j][i]=1/v; rebuildAllMatricesUI();
  });
}
rebuildAllMatricesUI();

/** ====== Alternatives table ====== **/
function renderAlts(){
  const tbody = document.getElementById('altRows');
  tbody.innerHTML = cfg.alternatives.map((a,idx)=>`
    <tr>
      <td>${a.name}</td>
      <td>${a.lokasi}</td>
      <td>${a.biaya}</td>
      <td>${a.fasilitas}</td>
      <td class="text-right">
        <button class="btn text-red-300" onclick="delAlt(${idx})">Hapus</button>
      </td>
    </tr>
  `).join('');
}
renderAlts();

document.getElementById('altForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('altName').value.trim();
  if(!name) return;
  cfg.alternatives.push({
    name,
    lokasi: document.getElementById('altLokasi').value,
    biaya: document.getElementById('altBiaya').value,
    fasilitas: document.getElementById('altFasilitas').value
  });
  e.target.reset();
  renderAlts();
});
window.delAlt = (i)=>{ cfg.alternatives.splice(i,1); renderAlts(); };

/** ====== AHP Math (geometric mean method) ====== **/
function priorityVectorGeometricMean(M){
  const n = M.length;
  const w = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    let prod = 1;
    for (let j=0;j<n;j++) prod *= M[i][j];
    w[i] = Math.pow(prod, 1/n);
  }
  const sum = w.reduce((a,b)=>a+b,0);
  return w.map(x=>x/sum);
}
function lambdaMax(M, w){
  const n = M.length;
  // λ_max ≈ average of (Aw / w)_i
  const Aw = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    let s=0;
    for (let j=0;j<n;j++) s+= M[i][j]*w[j];
    Aw[i]=s;
  }
  const ratios = Aw.map((x,i)=> x / w[i]);
  const avg = ratios.reduce((a,b)=>a+b,0) / n;
  return avg;
}
function ciCr(M, w){
  const n = M.length;
  const lmax = lambdaMax(M,w);
  const CI = (lmax - n) / (n - 1);
  const ri = RI[n] ?? 1.49; // fallback
  const CR = ri>0 ? CI/ri : 0;
  return {CI, CR, lambda: lmax};
}

function fmt(x){ return (Math.round(x*10000)/10000).toFixed(4); }
function pct(x){ return (x*100).toFixed(2) + '%'; }

function computeAll(){
  // criteria weights
  const wCrit = priorityVectorGeometricMean(cfg.matrices.criteria);
  const statsCrit = ciCr(cfg.matrices.criteria, wCrit);

  // sub weights
  const wSub = {};
  for (const k of cfg.criteria){
    const M = cfg.matrices.sub[k];
    const w = priorityVectorGeometricMean(M);
    const s = ciCr(M, w);
    wSub[k] = {labels: cfg.subcriteria[k], weights: w, stats: s};
  }

  // scoring alternatives (simple: weight of chosen category within each criterion)
  const rows = cfg.alternatives.map(a=>{
    let score = 0;
    const detail = {};
    cfg.criteria.forEach((c,ci)=>{
      const labels = cfg.subcriteria[c];
      const idx = labels.indexOf(a[c.toLowerCase()]); // a.lokasi / a.biaya / a.fasilitas
      const subw = wSub[c].weights[idx];
      detail[c] = {choice: labels[idx], w: subw, critW: wCrit[ci]};
      score += wCrit[ci] * subw;
    });
    return {name:a.name, score, detail};
  }).sort((x,y)=> y.score - x.score);

  // Render weights
  const weightsView = document.getElementById('weightsView');
  let whtml = '';
  whtml += `<div class="card p-4">
    <div class="font-medium mb-2">Bobot Kriteria</div>
    ${cfg.criteria.map((c,i)=>`<div class="flex justify-between"><div>${c}</div><div class="mono">${pct(wCrit[i])}</div></div>`).join('')}
    <div class="mt-2 text-xs ${statsCrit.CR<=0.1?'ok':(statsCrit.CR<=0.2?'warn':'bad')}">
      CR=${fmt(statsCrit.CR)} (≤0.10 direkomendasikan), λ<sub>max</sub>=${fmt(statsCrit.lambda)}, CI=${fmt(statsCrit.CI)}
    </div>
  </div>`;
  for (const c of cfg.criteria){
    const ws = wSub[c];
    whtml += `<div class="card p-4">
      <div class="font-medium mb-2">Bobot Subkriteria – ${c}</div>
      ${ws.labels.map((l,i)=>`<div class="flex justify-between"><div>${l}</div><div class="mono">${pct(ws.weights[i])}</div></div>`).join('')}
      <div class="mt-2 text-xs ${ws.stats.CR<=0.1?'ok':(ws.stats.CR<=0.2?'warn':'bad')}">
        CR=${fmt(ws.stats.CR)} (≤0.10 direkomendasikan), λ<sub>max</sub>=${fmt(ws.stats.lambda)}, CI=${fmt(ws.stats.CI)}
      </div>
    </div>`;
  }
  weightsView.innerHTML = whtml;

  // Render ranking
  const rankDiv = document.getElementById('rankView');
  let r = `<table class="w-full tbl text-sm"><thead class="muted">
            <tr><th>Rank</th><th>Nama</th><th>Score</th><th>Detail</th></tr></thead><tbody>`;
  rows.forEach((row,i)=>{
    const det = Object.entries(row.detail).map(([k,v])=>`${k}: ${v.choice} × ${pct(v.critW)} → ${pct(v.w)}`).join('<br>');
    r += `<tr><td>${i+1}</td><td>${row.name}</td><td class="mono">${pct(row.score)}</td><td class="muted">${det}</td></tr>`;
  });
  r += `</tbody></table>`;
  rankDiv.innerHTML = r;
}
computeAll();

/** ====== Helpers ====== **/
function equalizeCriteria(){
  const n = cfg.criteria.length;
  for(let i=0;i<n;i++) for(let j=0;j<n;j++){
    cfg.matrices.criteria[i][j] = (i===j)?1:1;
  }
  rebuildAllMatricesUI();
}
function randomizeCriteria(){
  const n = cfg.criteria.length;
  for(let i=0;i<n;i++) for(let j=i+1;j<n;j++){
    const v = saaty[Math.floor(Math.random()*saaty.length)];
    cfg.matrices.criteria[i][j]=v; cfg.matrices.criteria[j][i]=1/v;
  }
  rebuildAllMatricesUI();
}

/** ====== Import / Export YAML ====== **/
document.getElementById('btnExport').addEventListener('click', ()=>{
  const data = {
    criteria: cfg.criteria,
    subcriteria: cfg.subcriteria,
    matrices: cfg.matrices,
    alternatives: cfg.alternatives
  };
  const yaml = jsyaml.dump(data, {lineWidth: 120});
  const blob = new Blob([yaml], {type: 'text/yaml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ahp_kos_config.yaml'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('yamlFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const text = await f.text();
  let data = null;
  try{
    if(f.name.endsWith('.json')) data = JSON.parse(text);
    else data = jsyaml.load(text);
  } catch(err){
    setConfigState('Gagal memuat file: ' + err.message);
    return;
  }
  if(!data) return;
  // shallow validate
  if(!data.criteria || !data.subcriteria || !data.matrices || !data.alternatives){
    setConfigState('Format tidak valid. Diperlukan fields: criteria, subcriteria, matrices, alternatives.');
    return;
  }
  cfg = data;
  rebuildAllMatricesUI();
  renderAlts();
  computeAll();
  setConfigState('Berhasil memuat konfigurasi dari ' + f.name);
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm('Reset ke default?')) return;
  location.reload();
});
</script>
</body>
</html>
